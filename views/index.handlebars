<div class="container-fluid">
  <div class="row">
    <div class="col-sm-4 col-sm-offset-4" id="main-container">
      <div class="heading">
        <text class="title">Initiating</text>
        <text class="order">1</text>
      </div>
      <div class="hexagram">
        <div class="line yang">
          <div class="left">&nbsp;</div>
          <div class="right">&nbsp;</div>
        </div>
        <div class="line yang">
          <div class="left">&nbsp;</div>
          <div class="right">&nbsp;</div>
        </div>
        <div class="line yang">
          <div class="left">&nbsp;</div>
          <div class="right">&nbsp;</div>
        </div>
        <div class="line yang">
          <div class="left">&nbsp;</div>
          <div class="right">&nbsp;</div>
        </div>
        <div class="line yang">
          <div class="left">&nbsp;</div>
          <div class="right">&nbsp;</div>
        </div>
        <div class="line yang">
          <div class="left">&nbsp;</div>
          <div class="right">&nbsp;</div>
        </div>
      </div>
    </div>
  </div>
  <div id="arrows">
    <span id="left-arrow" class="glyphicon glyphicon-chevron-left glyph-arrows" aria-hidden="true"></span>
    <span id="right-arrow" class="glyphicon glyphicon-chevron-right glyph-arrows" aria-hidden="true"></span>
    <span id="flip" class="glyphicon glyphicon-menu-hamburger pull-right glyph-arrows" aria-hidden="true"></span>
    <span id="shuffle" class="glyphicon glyphicon-repeat glyph-arrows pull-right" aria-hidden="true"></span>
  </div>
</div>
<script src="/js/hexagrams.js"></script>
<script>
  $(document).ready(function () {
    jQuery.fn.reverse = [].reverse; // Smallest jquery plugin on earth
    var currentHexagram;

    var changeOrderHeading = function (order, delay) {
      var outOptions = {
        duration: 200,
        complete: function () {
          return $('.heading .order').text(order);
        }
      };

      if (!!delay) {
        outOptions.delay = delay;
      }

      return $('.heading .order').velocity('transition.flipXOut', outOptions).velocity('transition.flipXIn', 300);
    };

    var changeTitleHeading = function (title, delay) {
      var outOptions = {
        duration: 200,
        complete: function () {
          return $('.heading .title').text(title);
        }
      };

      if (!!delay) {
        outOptions.delay = delay;
      }

      return $('.heading .title').velocity({
        translateX: 100,
        opacity: 0
      }, outOptions).velocity('transition.slideRightIn', 300);
    };

    var changeSequence = function (sequence, cb) {
      return $('.hexagram').children().reverse().each(function (index, element) {
        var el = $(element);
        if (index < 5) {
          return changeLine(el, sequence[index]);
        } else {
          return changeLine(el, sequence[index], {
            complete: cb
          });
        }
      });
    };

    var flipSequence = function (cb) {
      var subroutine = function (index) {
        if (index === 5) {
          return changeLine(index, false, {
            duration: 500,
            delay: 500,
            complete: cb,
            changeInfo: true
          });
        } else {
          return changeLine(index, false, {
            delay: index !== 0 ? 500 : 0,
            duration: 500,
            changeInfo: true,
            complete: function () {
              return subroutine(index + 1);
            }
          })
        }
      };

      return subroutine(0);
    };

    var matchHexagram = function (sequence) {
      return _.find(hexagrams, function (hexagram) {
        return _.isEqual(hexagram.sequence, sequence);
      });
    };

    var getCurrentSequence = function () {
      var sequence = $('.hexagram').children('.line').map(function () {
        return !!$(this).hasClass('yang') ? 1 : 0;
      }).get().reverse();

      return sequence;
    };

    var changeCurrentHexagramInfo = function (delay) {
      changeOrderHeading(currentHexagram.order, delay);
      changeTitleHeading(currentHexagram.title, delay);

      return;
    };

    var shiftHexagrams = function (n) {
      var index;

      if (currentHexagram.order + n < 0) { // Handle edge cases of hexagram shifting
        index = 64 + (currentHexagram.order + n);
      } else if (currentHexagram.order + n > 64) {
        index = currentHexagram.order + n - 64;
      } else {
        index = currentHexagram.order + n;
      }

      var nextHex = _.find(hexagrams, function (hexagram) {
        return hexagram.order === index;
      });

      changeSequence(nextHex.sequence);
      changeCurrentHexagramInfo();

      return;
    };

    var coinFlip = function () {
      return Math.floor(Math.random() * 2);
    };

    var flip = true;

    var changeLine = function (indexOrElement, newState, options) {
      options = options || {};
      var el;

      if (_.isNumber(indexOrElement)) {
        el = $('.hexagram').children().reverse()[indexOrElement];
      } else {
        el = indexOrElement;
      }

      var yangOptions = _.extend({
        easing: 'spring'
      }, options);

      var yinOptions = _.extend({
        easing: 'spring'
      }, options);

      var needsToChange = function (el, next) {
        var flag = el.hasClass('yang') ? 1 : 0;
        return flag !== next;
      }

      var handleLine = function (el) {
        el = $(el);
        if (el.hasClass('yang')) {
          el.removeClass('yang').addClass('yin');
          el.children('.left').velocity({
            right: '66%'
          }, yangOptions);
          el.children('.right').velocity({
            left: '66%'
          }, _.omit(yangOptions, 'complete'));
        } else {
          el.removeClass('yin').addClass('yang');

          if (flip) {
            el.children('.left').velocity({
              right: '96%'
            }, yinOptions).velocity({
              right: '49%'
            }, 0);

            el.children('.right').velocity({
              left: '20px',
            }, _.omit(yinOptions, 'complete')).velocity({
              left: '49%',
            }, 0);

          } else {
            el.children('.right').velocity({
              left: '96%'
            }, yinOptions).velocity({
              left: '49%'
            }, 0);

            el.children('.left').velocity({
              right: '20px',
            }, _.omit(yinOptions, 'complete')).velocity({
              right: '49%',
            }, 0);
          }

          flip = !flip;
        }
      };

      if (_.isNumber(newState)) {
        if (needsToChange(el, newState)) {
          handleLine(el);
        }
      } else { // toggle
        handleLine(el);
      }

      currentHexagram = matchHexagram(getCurrentSequence());

      if (options.changeInfo) {
        changeCurrentHexagramInfo(options.delay);
      }

      return;
    };

    currentHexagram = matchHexagram(getCurrentSequence());

    $('.line').click(function () {
      return changeLine($(this), false, {
        changeInfo: true
      });
    });

    $('#left-arrow').click(function () {
      return shiftHexagrams(-1);
    });

    $('#right-arrow').click(function () {
      return shiftHexagrams(1);
    });

    $('#shuffle').click(function () {
      var newSequence = [];

      for (var i = 0; i < 6; i++) {
        result = coinFlip() + coinFlip() + coinFlip();
        newSequence.push(result >= 2 ? 1 : 0);
      }

      currentHexagram = matchHexagram(newSequence);
      changeSequence(newSequence);
      changeCurrentHexagramInfo();

      return;
    });

    $('#flip').click(function () {
      flipSequence();
    });
  });
</script>